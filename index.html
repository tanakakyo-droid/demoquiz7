<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fill-in-the-Blank Quiz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom, #ccff99, #ffffff);
    }
    header {
      background: #ccff66; /* ÈªÑÁ∑ë */
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #title {
      flex-grow: 1;
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }
    .quiz-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .input-field {
      margin: 10px;
      padding: 10px;
      font-size: 22px;
      width: 200px;
    }
    .button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background: #007BFF;
      color: white;
    }
    .circle-button {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      margin-left: 8px;
      cursor: pointer;
      background-color: #007BFF;
      color: white;
      font-size: 14px;
    }
    .progress-bar { width: 100%; background: #ddd; border-radius: 10px; margin-top: 20px; }
    .progress { height: 20px; background: #4CAF50; border-radius: 10px; width: 0%; }
    .hidden { display: none; }
    #question { font-size: 24px; margin-bottom: 20px; }
    #translation { font-size: 20px; margin-top: 15px; }
  </style>
</head>
<body>
  <header>
    <label id="nameLabel">ÂêçÂâç: <input type="text" id="username" placeholder="Your name"></label>
    <div id="title">English Quiz</div>
    <div>
      <button class="button hidden" id="retryBtn">Retry Incorrect Questions</button>
      <button class="button hidden" id="pdfBtn">Download PDF</button>
    </div>
  </header>

  <div class="quiz-container">
    <div id="question"></div>
    <div id="inputs"></div>
    <button class="button" id="submitBtn">Submit</button>
    <button class="button hidden" id="nextBtn">Next</button>
    <button class="button hidden" id="showAllBtn">Show All Results</button>
    <div id="feedback"></div>
    <div id="translation"></div>
    <div class="progress-bar" id="progressBar"><div class="progress" id="progress"></div></div>
    <div id="scoreBoard"></div>
  </div>

  <script>
    const questions = [
      { sentence: "The capital of France is ___ and it is famous for the Eiffel Tower.",
        answers: ["Paris"], translation: "The capital of France is Paris and it is famous for the Eiffel Tower.",
        jpTranslation: "„Éï„É©„É≥„Çπ„ÅÆÈ¶ñÈÉΩ„ÅØ„Éë„É™„Åß„ÄÅ„Ç®„ÉÉ„Éï„Çß„É´Â°î„ÅßÊúâÂêç„Åß„Åô„ÄÇ", blanksTranslation: ["„Éë„É™"] },
      { sentence: "Water boils at ___ degrees Celsius and freezes at ___ degrees.",
        answers: ["100", "0"], translation: "Water boils at 100 degrees Celsius and freezes at 0 degrees.",
        jpTranslation: "Ê∞¥„ÅØ100Â∫¶„ÅßÊ≤∏È®∞„Åó„ÄÅ0Â∫¶„ÅßÂáç„Çä„Åæ„Åô„ÄÇ", blanksTranslation: ["100Â∫¶", "0Â∫¶"] }
    ];

    let current = 0, score = 0;
    let userAnswers = [], incorrectQuestions = [], retryMode = false;

    const qEl = document.getElementById("question");
    const inputEl = document.getElementById("inputs");
    const feedbackEl = document.getElementById("feedback");
    const translationEl = document.getElementById("translation");
    const progressEl = document.getElementById("progress");
    const progressBar = document.getElementById("progressBar");
    const scoreBoard = document.getElementById("scoreBoard");
    const pdfBtn = document.getElementById("pdfBtn");
    const retryBtn = document.getElementById("retryBtn");
    const showAllBtn = document.getElementById("showAllBtn");
    const nameLabel = document.getElementById("nameLabel");

    function loadQuestion() {
      const q = questions[current];
      qEl.textContent = q.sentence;
      inputEl.innerHTML = "";
      feedbackEl.textContent = "";
      translationEl.textContent = "";

      q.answers.forEach((_, i) => {
        const inp = document.createElement("input");
        inp.type = "text";
        inp.className = "input-field";
        inp.id = "ans" + i;
        inputEl.appendChild(inp);
      });

      document.getElementById("submitBtn").classList.remove("hidden");
      document.getElementById("nextBtn").classList.add("hidden");

      document.querySelectorAll(".input-field").forEach(inp => {
        inp.addEventListener("keypress", e => {
          if (e.key === "Enter") { checkAnswer(); e.preventDefault(); }
        });
      });

      progressEl.style.width = `${(current / questions.length) * 100}%`;
    }

    function checkAnswer() {
      const q = questions[current];
      let correct = true, answersGiven = [];

      q.answers.forEach((ans, i) => {
        const userAns = document.getElementById("ans" + i).value.trim();
        answersGiven.push(userAns);
        if (userAns.toLowerCase() !== ans.toLowerCase()) correct = false;
      });

      userAnswers.push({ question: q.sentence, user: answersGiven, correct: q.answers });

      if (correct) { feedbackEl.textContent = "‚úÖ Correct!"; score++; }
      else { feedbackEl.textContent = "‚ùå Incorrect!"; incorrectQuestions.push(q); }

      let highlighted = q.translation;
      q.answers.forEach(ans => {
        const regex = new RegExp(`\\b${ans}\\b`, "gi");
        highlighted = highlighted.replace(regex, `<span style="color:red;">${ans}</span>`);
      });

      translationEl.innerHTML = `
        <p><b>Ëã±Êñá:</b> ${highlighted}</p>
        <p><b>Á≠î„Åà:</b> ${q.answers.join(", ")}</p>
        <p><b>ÂíåË®≥:</b> ${q.jpTranslation}</p>
        <p><b>Á≠î„Åà„ÅÆÂíåË®≥:</b> ${q.blanksTranslation.join(", ")}</p>
      `;

      // Èü≥Â£∞„Éú„Çø„É≥
      const speakBtnSentence = document.createElement("button");
      speakBtnSentence.textContent = "üîä";
      speakBtnSentence.className = "circle-button";
      speakBtnSentence.onclick = () => speak(q.translation);
      translationEl.querySelector("p").appendChild(speakBtnSentence);

      q.answers.forEach(ans => {
        const btnWord = document.createElement("button");
        btnWord.textContent = "üîä";
        btnWord.className = "circle-button";
        btnWord.onclick = () => speak(ans);
        translationEl.querySelector("p:nth-child(2)").appendChild(btnWord);
      });

      document.getElementById("submitBtn").classList.add("hidden");
      document.getElementById("nextBtn").classList.remove("hidden");
    }

    function nextQuestion() {
      current++;
      if (current < questions.length) {
        loadQuestion();
      } else {
        progressEl.style.width = "100%";
        scoreBoard.textContent = `Your score: ${score} / ${questions.length}`;
        progressBar.classList.add("hidden");
        showAllBtn.classList.remove("hidden");
        nameLabel.classList.add("hidden");
      }
    }

    function speak(text) {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      speechSynthesis.speak(u);
    }

    function showAllResults() {
      qEl.textContent = "All Results";
      inputEl.innerHTML = "";
      feedbackEl.textContent = "";
      translationEl.innerHTML = "";

      const username = document.getElementById("username").value.trim();
      translationEl.innerHTML = `<p><b>Name:</b> ${username || "(No name)"}</p>
                                 <p><b>Score:</b> ${score} / ${questions.length}</p>`;

      userAnswers.forEach((entry, idx) => {
        const div = document.createElement("div");
        div.style.textAlign = "left";
        div.style.margin = "10px";
        div.innerHTML = `
          <p><b>Q${idx + 1}:</b> ${entry.question}</p>
          <p>Your Answer: ${entry.user.join(", ")} | Correct: ${entry.correct.join(", ")}</p>
        `;
        translationEl.appendChild(div);
      });

      pdfBtn.classList.remove("hidden");
      if (incorrectQuestions.length > 0 && !retryMode) retryBtn.classList.remove("hidden");

      showAllBtn.classList.add("hidden");
      document.getElementById("nextBtn").classList.add("hidden");
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const username = document.getElementById("username").value.trim();

      doc.setFontSize(14);
      doc.text("Quiz Results", 10, 10);
      if (username) doc.text(`Name: ${username}`, 150, 10);
      doc.text(`Score: ${score} / ${questions.length}`, 10, 20);

      let y = 30;
      userAnswers.forEach((entry, idx) => {
        const linesQ = doc.splitTextToSize(`${idx + 1}. Question: ${entry.question}`, 180);
        doc.text(linesQ, 10, y); y += linesQ.length * 8;

        const linesU = doc.splitTextToSize(`Your Answer: ${entry.user.join(", ")}`, 180);
        doc.text(linesU, 10, y); y += linesU.length * 8;

        const linesC = doc.splitTextToSize(`Correct Answer: ${entry.correct.join(", ")}`, 180);
        doc.text(linesC, 10, y); y += linesC.length * 8 + 5;

        if (y > 270) { doc.addPage(); y = 20; }
      });

      doc.save("quiz_results.pdf");
    }

    pdfBtn.onclick = downloadPDF;
    document.getElementById("submitBtn").onclick = checkAnswer;
    document.getElementById("nextBtn").onclick = nextQuestion;
    showAllBtn.onclick = showAllResults;

    loadQuestion();
  </script>
</body>
</html>
